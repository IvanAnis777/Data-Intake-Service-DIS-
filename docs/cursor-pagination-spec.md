# Спецификация курсорной пагинации

## Обзор

Курсорная пагинация (keyset pagination) реализована для эндпоинта `GET /api/v1/items` с использованием пары `(created_at, id)` для обеспечения стабильной и производительной пагинации больших таблиц.

## Формат курсора

### Структура данных
Курсор представляет собой JSON объект, закодированный в base64:

```json
{
  "created_at": "2024-01-15T10:30:00+00:00",
  "id": 123
}
```

### Кодирование
- JSON сериализация с компактным форматом (без пробелов)
- Base64 кодирование результата
- Пример: `eyJjcmVhdGVkX2F0IjogIjIwMjQtMDEtMTVUMTA6MzA6MDBaIiwgImlkIjogMTIzfQ==`

### Валидация
- `created_at`: ISO 8601 формат с timezone (поддерживается Z суффикс)
- `id`: положительное целое число
- При ошибке валидации возвращается HTTP 400 с описанием ошибки

## API Контракты

### Запрос

```
GET /api/v1/items?limit=100&cursor={base64}&status=active&brand=BrandA&category=Electronics
```

#### Параметры запроса

| Параметр | Тип | Обязательный | Описание | Ограничения |
|----------|-----|--------------|----------|-------------|
| `limit` | integer | Нет | Количество элементов на странице | 1-1000, по умолчанию 100 |
| `cursor` | string | Нет | Курсор для пагинации | Base64 закодированная строка |
| `status` | string | Нет | Фильтр по статусу | Любое значение |
| `brand` | string | Нет | Фильтр по бренду | Любое значение |
| `category` | string | Нет | Фильтр по категории | Любое значение |

### Ответ

```json
{
  "items": [
    {
      "id": 1,
      "sku": "ITEM-001",
      "title": "Sample Item",
      "status": "active",
      "brand": "Brand A",
      "category": "Electronics",
      "created_at": "2024-01-15T10:30:00Z"
    }
  ],
  "next_cursor": "eyJjcmVhdGVkX2F0IjogIjIwMjQtMDEtMTVUMTA6MzA6MDBaIiwgImlkIjogMTIzfQ==",
  "has_more": true
}
```

#### Поля ответа

| Поле | Тип | Описание |
|------|-----|----------|
| `items` | array | Массив элементов Item |
| `next_cursor` | string\|null | Курсор для следующей страницы (null если нет) |
| `has_more` | boolean | Есть ли еще страницы |

## Алгоритм пагинации

### Сортировка
- Основная сортировка: `created_at DESC`
- Вторичная сортировка: `id DESC` (для стабильности при одинаковом времени)

### Фильтрация с курсором
Для SQLite используется составное условие:
```sql
WHERE (created_at < ? OR (created_at = ? AND id < ?))
```

### Определение has_more
- Запрашивается `limit + 1` элементов
- Если получено больше `limit` элементов, то `has_more = true`
- Лишний элемент удаляется из результата

## Примеры использования

### Первая страница
```bash
curl "http://localhost:8000/api/v1/items?limit=10"
```

Ответ:
```json
{
  "items": [...],
  "next_cursor": "eyJjcmVhdGVkX2F0IjogIjIwMjQtMDEtMTVUMTA6MzA6MDBaIiwgImlkIjogMTIzfQ==",
  "has_more": true
}
```

### Следующая страница
```bash
curl "http://localhost:8000/api/v1/items?limit=10&cursor=eyJjcmVhdGVkX2F0IjogIjIwMjQtMDEtMTVUMTA6MzA6MDBaIiwgImlkIjogMTIzfQ=="
```

### С фильтрацией
```bash
curl "http://localhost:8000/api/v1/items?limit=10&status=active&brand=BrandA"
```

## Обработка ошибок

### HTTP 400 - Невалидный курсор
```json
{
  "detail": "Invalid cursor format: Invalid base64 encoding: ..."
}
```

Возможные причины:
- Невалидный base64
- Невалидный JSON
- Отсутствующие поля `created_at` или `id`
- Невалидный формат даты
- Невалидный ID (не число, отрицательный, ноль)

### HTTP 422 - Ошибки валидации параметров
```json
{
  "detail": [
    {
      "loc": ["query", "limit"],
      "msg": "ensure this value is greater than or equal to 1",
      "type": "value_error.number.not_ge"
    }
  ]
}
```

Возможные причины:
- `limit` < 1 или > 1000
- Невалидные типы параметров

## Инварианты

### Стабильность порядка
- Порядок элементов стабилен между запросами
- Новые элементы не влияют на порядок существующих страниц
- При одинаковом `created_at` сортировка по `id` обеспечивает детерминизм

### Отсутствие дрейфа
- Вставки новых элементов не вызывают "дрейф" страниц
- Элементы не дублируются между страницами
- Элементы не пропускаются при пагинации

### Производительность
- Время ответа не зависит от глубины пагинации
- Используется составной индекс `(created_at, id)`
- P95 latency остается стабильным на глубине 1000+ страниц

## Ограничения

### Максимальный лимит
- `limit` ограничен значением 1000
- Рекомендуется использовать значения 10-100 для оптимальной производительности

### Совместимость с SQLite
- Реализация оптимизирована для SQLite
- Для PostgreSQL можно использовать более эффективные конструкции

### Фильтрация
- Фильтры применяются до курсорной пагинации
- Комбинация фильтров может значительно уменьшить количество результатов

## Мониторинг и метрики

### Логируемые метрики
- `api.items.list.latency_ms` - время ответа в миллисекундах
- `api.items.list.limit` - размер страницы
- `api.items.list.pages_depth` - глубина пагинации ("first" или "deep")
- `api.items.list.cursor_errors` - количество ошибок декодирования курсора

### Алерты
- Время ответа > 100ms для одной страницы
- Время ответа > 1s для глубокой пагинации
- Высокий уровень ошибок декодирования курсора

## Миграция с offset-based пагинации

### Изменения в API
- Параметр `skip` заменен на `cursor`
- Ответ содержит `next_cursor` и `has_more` вместо `total_count`
- Удален параметр `total_count` (не поддерживается в курсорной пагинации)

### Обратная совместимость
- Старые клиенты с `skip` параметром получат ошибку валидации
- Рекомендуется обновить клиентский код для использования курсоров

## Тестирование

### Unit тесты
- Кодирование/декодирование курсоров
- Валидация форматов
- Обработка ошибок

### Integration тесты
- Стабильность порядка между страницами
- Отсутствие дрейфа при вставках
- Фильтрация с пагинацией
- Производительность глубокой пагинации

### Нагрузочные тесты
- 1000+ страниц пагинации
- P95 latency < 100ms
- Отсутствие деградации производительности

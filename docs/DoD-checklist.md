# Definition of Done (DoD) - Чек-лист

## Блок 1: Каркас сервиса (скелет)

### ✅ Функциональные требования
- [x] Минимальные сущности: Item (id, sku, title, created_at)
- [x] OpenAPI/Swagger документация доступна
- [x] Health эндпоинты: `/healthz`, `/readyz`
- [x] Базовые middleware: request-id, correlation-id, логирование

### ✅ Технические требования
- [x] FastAPI приложение запускается без ошибок
- [x] SQLite база данных создается и работает
- [x] Структурированное JSON логирование
- [x] CORS middleware настроен
- [x] Модульная структура проекта

### ✅ Проверки
- [x] Health отдаёт 200 OK
- [x] OpenAPI генерируется автоматически
- [x] Лог видит correlation-id в каждом запросе
- [x] Создание Item работает (POST /api/v1/items)
- [x] Получение Item работает (GET /api/v1/items/{id})
- [x] Список Items работает (GET /api/v1/items)

### ✅ Документация
- [x] ADR №1 «Архитектурные решения»
- [x] README с целями и инструкциями по запуску
- [x] Чек-лист DoD блока

### ✅ Качество кода
- [x] Код следует PEP 8
- [x] Типизация с помощью type hints
- [x] Обработка ошибок
- [x] Валидация входных данных

## Критерии готовности блока

Блок считается готовым, когда:
1. ✅ Все функциональные требования выполнены
2. ✅ Все технические требования выполнены  
3. ✅ Все проверки проходят успешно
4. ✅ Документация создана и актуальна
5. ✅ Код проходит базовые проверки качества

## Блок 3: Курсорная пагинация

### ✅ Функциональные требования
- [x] Реализация курсорной пагинации для GET /api/v1/items
- [x] Поддержка параметров: cursor, limit, status, brand, category
- [x] Метаданные пагинации в ответе (next_cursor, has_more)
- [x] Фильтрация по статусу, бренду и категории
- [x] Стабильная сортировка по (created_at, id)

### ✅ Технические требования
- [x] Keyset pagination на паре (created_at, id)
- [x] Base64 кодирование курсора с JSON структурой
- [x] Составной индекс для производительности
- [x] Валидация курсора с обработкой ошибок
- [x] Ограничение limit: 1-1000 элементов

### ✅ Проверки
- [x] Первая страница без курсора работает
- [x] Последующие страницы с курсором работают
- [x] Стабильность порядка между страницами
- [x] Отсутствие дрейфа при вставках
- [x] Фильтрация работает с пагинацией
- [x] Битый курсор возвращает HTTP 400
- [x] Производительность стабильна на глубине 1000+ страниц

### ✅ Тестирование
- [x] Unit тесты для cursor utils (encode/decode/errors)
- [x] Integration тесты пагинации (стабильность, вставки, фильтры)
- [x] Тесты обработки ошибок курсора
- [x] Тесты производительности глубокой пагинации
- [x] Тесты граничных случаев

### ✅ Документация
- [x] Спецификация курсорной пагинации (docs/cursor-pagination-spec.md)
- [x] Примеры запросов и ответов
- [x] Описание формата курсора
- [x] Обработка ошибок
- [x] Обновление test-scenarios.md

### ✅ Мониторинг
- [x] Метрики latency_ms для пагинации
- [x] Метрики pages_depth (first/deep)
- [x] Счетчик ошибок декодирования курсора
- [x] Логирование в middleware

## Критерии готовности блока

Блок считается готовым, когда:
1. ✅ Все функциональные требования выполнены
2. ✅ Все технические требования выполнены  
3. ✅ Все проверки проходят успешно
4. ✅ Тестирование покрывает основные сценарии
5. ✅ Документация создана и актуальна
6. ✅ Мониторинг настроен

## Блок 4: Идемпотентность POST при ретраях

### ✅ Функциональные требования
- [x] Поддержка заголовка Idempotency-Key для POST запросов
- [x] Хеширование тела запроса (SHA-256)
- [x] Управление состояниями ключей (processing → completed)
- [x] TTL механизм (1 час по умолчанию)
- [x] Обработка race conditions
- [x] Автоматическая очистка истёкших ключей

### ✅ Технические требования
- [x] SQLAlchemy модель IdempotencyKey с индексами
- [x] IdempotencyMiddleware для обработки запросов
- [x] Валидация формата ключей (1-255 символов, буквы/цифры/дефис/подчёркивание)
- [x] Фоновая задача очистки каждые 10 минут
- [x] Логирование всех операций идемпотентности
- [x] Обработка ошибок и исключений

### ✅ Проверки
- [x] POST без заголовка работает как обычно
- [x] Повторный запрос с тем же ключом и телом возвращает тот же ответ
- [x] Запрос с тем же ключом, но другим телом возвращает 409 Conflict
- [x] Race conditions обрабатываются корректно
- [x] TTL механизм работает (истёкшие ключи можно использовать повторно)
- [x] Валидация отклоняет невалидные ключи с HTTP 400
- [x] Автоматическая очистка истёкших ключей

### ✅ Тестирование
- [x] Unit тесты для утилит идемпотентности
- [x] Integration тесты базовых сценариев
- [x] Тесты race conditions и параллельных запросов
- [x] Тесты TTL и временных интервалов
- [x] Тесты валидации ключей
- [x] Тесты очистки истёкших ключей

### ✅ Документация
- [x] Спецификация идемпотентности (docs/idempotency-spec.md)
- [x] Описание заголовка Idempotency-Key в OpenAPI
- [x] Примеры использования и коды ошибок
- [x] Обновление test-scenarios.md с новыми сценариями
- [x] Обновление DoD-checklist.md

### ✅ Мониторинг
- [x] Метрики hit/miss/conflict для идемпотентности
- [x] Логирование операций с ключами
- [x] Счетчик очищенных ключей
- [x] Структурированное логирование всех операций

## Критерии готовности блока

Блок считается готовым, когда:
1. ✅ Все функциональные требования выполнены
2. ✅ Все технические требования выполнены  
3. ✅ Все проверки проходят успешно
4. ✅ Тестирование покрывает основные сценарии
5. ✅ Документация создана и актуальна
6. ✅ Мониторинг настроен

## Блок 5: Bulk API (синхронный, частичная успешность)

### Функциональные требования
- [x] API endpoint `POST /api/v1/items:bulk` для массового импорта
- [x] Поддержка частичной успешности (207 Multi-Status)
- [x] Построчная валидация с детальными ошибками
- [x] Обработка дубликатов SKU
- [x] Лимиты: максимум 1000 items, 10MB размер запроса

### Технические требования
- [x] Модели данных: `BulkImportRequest`, `BulkImportResponse`, `BulkItemResult`
- [x] Бизнес-логика в `BulkService` с отдельными транзакциями
- [x] API endpoint с валидацией лимитов
- [x] Коды ошибок: `DUPLICATE_SKU`, `VALIDATION_ERROR`, `INTERNAL_ERROR`
- [x] "Якорные" ошибки (400/413) останавливают обработку

### Проверки
- [x] Валидация размера запроса (≤ 10MB)
- [x] Валидация количества items (≤ 1000)
- [x] Построчная валидация каждого item
- [x] Проверка дубликатов SKU
- [x] Обработка в отдельных транзакциях
- [x] Детальный отчёт с per-line результатами

### Тестирование
- [x] Тест всех успешных items (200 OK)
- [x] Тест смешанных результатов (207 Multi-Status)
- [x] Тест всех ошибок (207 Multi-Status)
- [x] Тест дубликатов SKU
- [x] Тест на лимите (1000 items)
- [x] Тест превышения лимита (> 1000 items)
- [x] Тест пустого массива
- [x] Тест ошибок валидации
- [x] Тест частичной успешности

### Документация
- [x] Спецификация API (`docs/bulk-api-spec.md`)
- [x] Примеры запросов/ответов
- [x] Коды ошибок и их описания
- [x] Лимиты и ограничения
- [x] Best practices для клиентов

### Мониторинг
- [x] Метрики: `bulk.total_items`, `bulk.successful_items`, `bulk.failed_items`
- [x] Метрика времени обработки: `bulk.processing_time_ms`
- [x] Логирование с correlation_id
- [x] Обработка ошибок с детальным логированием

### Критерии готовности (DoD)
1. ✅ API endpoint `POST /api/v1/items:bulk` работает
2. ✅ Возвращает 200/207 с per-line результатами
3. ✅ Построчная валидация реализована
4. ✅ "Якорные" ошибки обрабатываются
5. ✅ Частичная успешность работает
6. ✅ Лимиты (1000 items, 10MB) проверяются
7. ✅ Все тесты проходят
8. ✅ Документация создана

## Следующий блок: Асинхронные массовые операции

### Планируемые требования
- [ ] Реализация bulk jobs для асинхронных массовых операций
- [ ] Поддержка импорта/экспорта больших объёмов данных
- [ ] Отслеживание прогресса операций
- [ ] Обработка ошибок в массовых операциях
- [ ] API для управления массовыми задачами











